<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
  <meta name="author" content="jim price">
  <meta name="description" content="Sept. 24 2022 Zig Vancouver Meetup">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Zig Vancouver Meetup</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/black.css">

    <link rel="stylesheet" href="plugin/highlight/monokai.css">
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        
<section>
  <h1>Zig Vancouver Meetup</h1>
  <h3>Sept. 24, 2022</h3>
  <img src="imgs/zig_vancouver.jpeg">
</section>

<section data-auto-animate>
  <h1>Introductions!</h1>
</section>

<section data-auto-animate>
  <h1>Introductions!</h1>
  <h3>Who am I?</h3>
  <ul>
    <li>Worked in VFX for over 20 years</li>
    <li>Currently FX Technical Supervisor</li>
    <li>Been at DNEG for 4 years</li>
  </ul>
</section>

<section>
  <section data-auto-animate>
    <h1>TODO DNEG LOGO</h1>
    <h4>Who is DNEG?</h4>
  </section>
  
  <section data-auto-animate>
    <h1>TODO DNEG LOGO</h1>
    <h4>Who is DNEG?</h4>
    <ul>
        <li>VFX for Film and Episodic</li>
        <li>Feature Animation</li>
        <li>Stereo Conversion</li>
        <li>Virtual Production</li>
    </ul>
  </section>
  
  <section>
    <h3>Who is DNEG?</h3>
    <img src="imgs/dneg_projects.jpg">
  </section>
</section>

<section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_base.png">
</section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_c.png">
</section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_python.png">
</section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_domain.png">
</section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_rnd.png">
</section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_td.png">
</section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_artists.png">
</section>
<section data-transition="fade">
  <h1>Technology at a VFX Studio</h1>
  <h3>Programming Languages</h3>
  <img src="imgs/languages_zig.png">
</section>
</section>

<section data-auto-animate>
  <h1>Why Zig?</h1>
</section>
<section data-auto-animate>
  <h1>Why Zig?</h1>
  <ul>
    <li>Performant</li>
    <li>Small</li>
    <!-- The Language can fit in my brain -->
    <li>Read Centric</li>
    <!-- Pick up a code base every few months, so being able to get going quickly is important -->
    <li>Standard Library</li>
    <!-- Useful data structures and utilities builtin -->
    <li>Interops well with C</li>
    <!-- Can work with existing libraries with that is more ergonomic and safe than C -->
    <li>Friendly to non-computer engineers</li>
    <!-- I'm not a full time developer, but with a little bit of effort was up and running with Zig
        in about a week. -->
  </ul>
</section>

<section data-auto-animate>
<h1>Case Studies</h1>
</section>

<section data-auto-animate>
<h1>Case Studies</h1>
<h3 style="color:red">Disclaimer:</h3>
Due to NDAs, these are not actual production examples.
<p>
These are simple examples that were created at home to demonstrate<br>
some of the benefits that Zig could have in production environments.
<p>
No production technology was harmed in the making of these slides.
</section>

<section>
  <section data-auto-animate>
    <h1>Case Study</h1>
    <h3>RenderMan Plugin</h3>
  </section>

  <section data-auto-animate>
    <h3>RenderMan Plugin</h3>
    <br><br><br>
    What problem are we trying to solve?
  </section>

  <section>
    Data Storage and I/O
  </section>
  <section>
    <video controls data-src="videos/dunes.mp4"></video>
  </section>

  <section>
    <h3>File Sizes</h3>
    <ul>
      <li>Explicit Points: 1915 MB</li>
    </ul>
  </section>

  <section>
    <h3>Data Storage and I/O</h3>
    <img src="imgs/io.png">
  </section>

  <section>
  <h3>Some Zig Code!</h3>
  Finally!
  <pre>
  <code data-trim class="zig" data-line-numbers="|1-8|12-14">
// ri.zig

pub const Float = f32;
pub const Point = [3]Float;
pub const Color = [3]Float;
pub const Int = i32;
pub const Token = ?[*:0]const u8;
pub const Pointer = ?*anyopaque;

pub const NULL: Pointer = null;

pub extern fn RiPoints(nverts: Int, ...) callconv(.C) void;
pub extern fn RiPointsV(nverts: Int, n: Int, nms: [*]Token, vals: [*]Pointer) callconv(.C) void;
pub extern fn RiSphere(radius: Float, zmin: Float, zmax: Float, tmax: Float, ...) callconv(.C) void;
  </code>
  </pre>
  </section>

  <section>
  <h3>The Point Generator</h3>
  <pre class="stretch">
  <code data-trim class="zig" 
    data-line-numbers="|1-3|5-11|12-13|15-18|20-22|23|24-25|26|27-33|36-39|41-43|45-51|53|54-56|57-62|63-64|66-69|70|3">
const std = @import("std");
const ri = @import("ri.zig");
const noise = @import("noise.zig");

pub export fn Subdivide2(
    ctx: *anyopaque,
    detail: ri.Float,
    n: ri.Int,
    toks: [*]ri.Token,
    vals: [*]ri.Pointer,
) void {
    _ = ctx;
    _ = detail;

    var prng = std.rand.DefaultPrng.init(42);
    const rand = prng.random();

    var num_points: i32 = 5000;

    //	Procedural2 "DynamicLoad2"  "SimpleBound" "constant float[6] __bound" [-5 5 0.0 0.5 -5 5] 
    //                              "constant string __dsoname" ["libptgen.so"]
    //                              "constant int num_points" [100000000]
    for (toks[0..@intCast(usize, n)]) |_, i| {
        var tok = toks[i] orelse continue;
        var val = vals[i] orelse continue;
        var iter = std.mem.split(u8, std.mem.span(tok), " ");
        var token_type = iter.next() orelse continue;
        var token_name = iter.next() orelse continue;
        if (std.mem.eql(u8, token_type, "int") and
            std.mem.eql(u8, token_name, "num_points"))
        {
            num_points = @ptrCast(*i32, @alignCast(@alignOf(i32), val)).*;
        }
    }

    const P_token: ri.Token = "P";
    const falloff_token: ri.Token = "constant float falloffpower";
    const width_token: ri.Token = "varying float width";
    const ids_token: ri.Token = "varying float id";

    var tokens = [4]ri.Token{ P_token, width_token, falloff_token, ids_token };
    var values: [4]ri.Pointer = .{null} ** 4;
    var falloff: ri.Float = 1.0;

    const allocator = std.heap.page_allocator;
    var pts = allocator.alloc(ri.Point, @intCast(usize, num_points)) catch return;
    defer allocator.free(pts);
    var ids = allocator.alloc(f32, @intCast(usize, num_points)) catch return;
    defer allocator.free(ids);
    var widths = allocator.alloc(f32, @intCast(usize, num_points)) catch return;
    defer allocator.free(widths);

    for (pts) |*pt, i| {
        var x_pos: ri.Float = (rand.float(ri.Float) - 0.5) * 10;
        var y_pos: ri.Float = rand.float(ri.Float);
        var z_pos: ri.Float = (rand.float(ri.Float) - 0.5) * 10;
        pt.* = ri.Point{
            x_pos,
            //(@cos(x_pos * std.math.pi) + y_pos) * 0.2,
            @floatCast(f32, (noise.improvedPerlin(x_pos, 0.5, z_pos) + y_pos) * 0.225),
            z_pos,
        };
        ids[i] = @intToFloat(f32, i);
        widths[i] = rand.float(ri.Float) * 0.0025 + 0.005;
    }
    values[0] = @as(ri.Pointer, pts.ptr);
    values[1] = @as(ri.Pointer, widths.ptr);
    values[2] = @as(ri.Pointer, &falloff);
    values[3] = @as(ri.Pointer, ids.ptr);
    ri.RiPointsV(num_points, tokens.len, &tokens, &values);
}
  </code>
  </pre>
  </section>
  
  <section>
  <h3>Improved Perlin Noise</h3>
  <pre class="stretch">
  <code data-trim class="zig" data-line-numbers="|79-96|98">
/// Improved Perlin Noise from
/// https://cs.nyu.edu/~perlin/noise/
/// http://mrl.nyu.edu/~perlin/paper445.pdf
pub fn improvedPerlin(x: f64, y: f64, z: f64) f64 {
    const fx = @floor(x);
    const fy = @floor(y);
    const fz = @floor(z);

    const dx = x - fx;
    const dy = y - fy;
    const dz = z - fz;

    const permutation_mask = @intCast(u32, noise_permutation_size - 1);
    const ix = @intCast(u32, @floatToInt(i32, fx) & permutation_mask);
    const iy = @intCast(u32, @floatToInt(i32, fy) & permutation_mask);
    const iz = @intCast(u32, @floatToInt(i32, fz) & permutation_mask);

    const wx = fade(dx);
    const wy = fade(dy);
    const wz = fade(dz);

    // zig fmt: off
    const w000 = grad(ix,   iy,   iz,   dx,   dy,   dz);
    const w100 = grad(ix+1, iy,   iz,   dx-1, dy,   dz);
    const w010 = grad(ix,   iy+1, iz,   dx,   dy-1, dz);
    const w110 = grad(ix+1, iy+1, iz,   dx-1, dy-1, dz);
    const w001 = grad(ix,   iy,   iz+1, dx,   dy,   dz-1);
    const w101 = grad(ix+1, iy,   iz+1, dx-1, dy,   dz-1);
    const w011 = grad(ix,   iy+1, iz+1, dx,   dy-1, dz-1);
    const w111 = grad(ix+1, iy+1, iz+1, dx-1, dy-1, dz-1);
    // zig fmt: on

    const w00 = lerp(wx, w000, w100);
    const w10 = lerp(wx, w010, w110);
    const w01 = lerp(wx, w001, w101);
    const w11 = lerp(wx, w011, w111);

    const w0 = lerp(wy, w00, w10);
    const w1 = lerp(wy, w01, w11);

    return lerp(wz, w0, w1);
}

fn fade(v: f64) f64 {
    return v * v * v * (v * (v * 6.0 - 15.0) + 10.0);
}

fn lerp(amount: f64, v0: f64, v1: f64) f64 {
    return v0 + amount * (v1 - v0);
}

fn grad(ix: u32, iy: u32, iz: u32, x: f64, y: f64, z: f64) f64 {
    const hash = noise_permutation[noise_permutation[noise_permutation[ix] + iy] + iz];
    // zig fmt: off
    switch (hash & 15) {
        0 => return   x + y,
        1 => return  -x + y,
        2 => return   x - y,
        3 => return  -x - y,
        4 => return   x + z,
        5 => return  -x + z,
        6 => return   x - z,
        7 => return  -x - z,
        8 => return   y + z,
        9 => return  -y + z,
        10 => return  y - z,
        11 => return -y - z,
        12 => return  x + y,
        13 => return -x + y,
        14 => return -y + z,
        15 => return -y - z,
        else => unreachable,
    }
    // zig fmt: on
    unreachable;
}

// zig fmt: off
const noise_permutation = [_]u32{
    151, 160, 137, 91, 90, 15, 131, 13, 201, 95, 96, 53, 194, 233, 7, 225, 140,
    36, 103, 30, 69, 142, 8, 99, 37, 240, 21, 10, 23, 190, 6, 148, 247, 120, 234,
    75, 0, 26, 197, 62, 94, 252, 219, 203, 117, 35, 11, 32, 57, 177, 33, 88, 237,
    149, 56, 87, 174, 20, 125, 136, 171, 168, 68, 175, 74, 165, 71, 134, 139,
    48, 27, 166, 77, 146, 158, 231, 83, 111, 229, 122, 60, 211, 133, 230, 220,
    105, 92, 41, 55, 46, 245, 40, 244, 102, 143, 54, 65, 25, 63, 161, 1, 216, 80,
    73, 209, 76, 132, 187, 208, 89, 18, 169, 200, 196, 135, 130, 116, 188, 159,
    86, 164, 100, 109, 198, 173, 186, 3, 64, 52, 217, 226, 250, 124, 123, 5,
    202, 38, 147, 118, 126, 255, 82, 85, 212, 207, 206, 59, 227, 47, 16, 58, 17,
    182, 189, 28, 42, 223, 183, 170, 213, 119, 248, 152, 2, 44, 154, 163, 70,
    221, 153, 101, 155, 167, 43, 172, 9, 129, 22, 39, 253, 19, 98, 108, 110, 79,
    113, 224, 232, 178, 185, 112, 104, 218, 246, 97, 228, 251, 34, 242, 193,
    238, 210, 144, 12, 191, 179, 162, 241, 81, 51, 145, 235, 249, 14, 239, 107,
    49, 192, 214, 31, 181, 199, 106, 157, 184, 84, 204, 176, 115, 121, 50, 45,
    127, 4, 150, 254, 138, 236, 205, 93, 222, 114, 67, 29, 24, 72, 243, 141,
    128, 195, 78, 66, 215, 61, 156, 180
}**2;
// zig fmt: on
const noise_permutation_size = noise_permutation.len / 2;
  </code>
  </pre>
  </section>

  <section>
    Houdini demo with the procedural now.
  </section>

  <section>
    <h3>File Sizes</h3>
    <ul>
      <li>Explicit Points: 1915 MB</li>
      <li>Procedural Points: 8 MB</li>
    </ul>
  </section>
</section>

<section>
<h1>Case Studies</h1>
<h3>Houdini Engine</h3>
</section>

<section>
<h1>Case Studies</h1>
<h3>Realtime Monitors</h3>
</section>

<section>
<h1>Questions?</h1>
</section>

      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,
        width: 1920,
        height: 1080,
        highlight: {
          beforeHighlight: hljs => hljs.registerLanguage("zig", function(hljs) {
            const QUOTE_STRING = {
              className: 'string',
              begin: '"',
              end: '"',
              contains: [ hljs.BACKSLASH_ESCAPE ]
            };
            const NUMBER_MODE = {
              className: 'number',
              begin: '(-?)(\\b0[xX][a-fA-F0-9]+|\\b0[bB][01]+|(\\b\\d+(_\\d+)?(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)',
              relevance: 0
            }
            return {
              keywords: {
                keyword:
                  'if else switch catch errdefer orelse '
                  + 'try asm async await break continue return '
                  + 'comptime defer fn pub resume suspend nosuspend '
                  + 'test unreachable usingnamespace and or for while '
                  + 'align allowzero callconv const var volatile export '
                  + 'extern linksection noalias packed threadlocal enum '
                  + 'error opaque struct union _',
                literal: 'true false null undefined',
                type: 
                  'bool void f32 f64 i32 u8 u32 usize anyerror '
                  + 'anyframe anyopaque anytype noreturn type',
                attribute: 
                  '@as @import @cImport @cInclude @floor @intCast @floatCast '
                  + '@intToFloat @floatToInt @ptrCast @alignCast @alignOf',
                $pattern: /@?\w+(\d+)?/
              },
              contains: [
                hljs.C_LINE_COMMENT_MODE,
                QUOTE_STRING,
                NUMBER_MODE
              ]
            };
          })
        },
        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
      });
    </script>
  </body>
</html>
